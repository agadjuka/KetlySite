# Управление сессиями (Session ID / User ID)

## Текущая реализация

### Создание Session ID

Session ID создается через хук `useSession` в файле `src/hooks/useSession.ts`.

Механизм работы:
1. Хук использует `useState` с пустой строкой для SSR-совместимости
2. В `useEffect` (после монтирования компонента на клиенте) вызывается `generateSessionId()`
3. `generateSessionId()` находится в `src/lib/id.ts` и использует `uuid.v4()` для генерации UUID
4. Каждый раз при монтировании компонента создается новый UUID

### Использование Session ID

Session ID используется в следующих местах:

1. **Хук useChat** (`src/hooks/useChat.ts`):
   - Строка 28: `const sessionId = useSession();` - получает sessionId
   - Строка 102: передается в `sendMessageToBackend(sanitizedText, sessionId, language)`
   - SessionId используется при каждой отправке сообщения

2. **Сервис chatService** (`src/services/chatService.ts`):
   - Строка 14: принимает `sessionId: string` как параметр
   - Строка 24: отправляется на бэкенд в теле запроса как `thread_id: sessionId`
   - Запрос: POST на `NEXT_PUBLIC_API_URL` с телом `{ message, thread_id: sessionId, language }`

### Проблема

При каждом монтировании компонента создается новый UUID. Это означает:
- При перезагрузке страницы создается новый sessionId
- При ре-рендере компонента, если хук перемонтируется, создается новый sessionId
- Нет сохранения sessionId между сессиями браузера

### Решение для предотвращения создания новых сессий

Чтобы при каждом сообщении не создавались новые сессии, нужно:

1. **Сохранять sessionId в localStorage**:
   - При первом создании sessionId сохранять его в `localStorage`
   - При последующих монтированиях читать из `localStorage`
   - Если в `localStorage` нет sessionId, только тогда создавать новый

2. **Модифицировать useSession.ts**:
   - Добавить проверку `localStorage.getItem('sessionId')`
   - Если существует - использовать его
   - Если не существует - создать новый и сохранить в `localStorage`
   - Учесть SSR: проверку localStorage делать только в `useEffect`

3. **Структура хранения**:
   - Ключ: `'sessionId'`
   - Значение: строка UUID
   - Срок хранения: до явного удаления или очистки браузера

### Ключевые файлы для изменения

- `src/hooks/useSession.ts` - основной файл для модификации
- `src/lib/id.ts` - функция генерации ID (можно оставить без изменений)
- `src/hooks/useChat.ts` - использует sessionId (не требует изменений, если useSession будет возвращать сохраненный ID)
- `src/services/chatService.ts` - отправляет thread_id (не требует изменений)

### Важные моменты

- SessionId должен быть одинаковым для всех сообщений в рамках одной сессии браузера
- При очистке localStorage или в приватном режиме создается новый sessionId
- SessionId не должен меняться при перезагрузке страницы в той же вкладке браузера
- SessionId должен быть уникальным для каждого пользователя/устройства

